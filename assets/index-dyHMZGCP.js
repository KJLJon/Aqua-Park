import{P as y}from"./phaser-0RJB29YE.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();class X extends y.Scene{constructor(){super({key:"BootScene"})}preload(){const e=this.add.graphics(),t=this.add.graphics(),{width:i,height:s}=this.cameras.main;t.fillStyle(2236962,.8),t.fillRoundedRect(i/2-120,s/2-15,240,30,10);const n=this.add.text(i/2,s/2-40,"Loading...",{fontSize:"20px",color:"#ffffff"}).setOrigin(.5);this.load.on("progress",a=>{e.clear(),e.fillStyle(46296,1),e.fillRoundedRect(i/2-115,s/2-10,230*a,20,8);const r=document.getElementById("progress-bar"),o=document.getElementById("progress-text");r&&(r.style.width=`${Math.floor(a*100)}%`),o&&(o.textContent=`${Math.floor(a*100)}%`)}),this.load.on("complete",()=>{e.destroy(),t.destroy(),n.destroy();const a=document.getElementById("install-progress");a&&a.classList.add("hidden")}),this.generatePlaceholderAssets()}create(){this.scene.start("MenuScene")}generatePlaceholderAssets(){const e=this.add.graphics();e.setVisible(!1),this.generatePlayerTextures(e),e.clear(),e.fillStyle(46296,1),e.fillRect(0,0,64,64),e.fillStyle(38599,1),e.fillRect(0,0,64,4),e.fillRect(0,60,64,4),e.lineStyle(1,4770532,.5);for(let t=0;t<64;t+=16)e.lineBetween(t,0,t,64);e.generateTexture("slide_tile",64,64),e.clear(),e.fillStyle(9494767,1),e.fillRect(0,0,64,64),e.fillStyle(11397364,.6);for(let t=0;t<5;t++)e.fillEllipse(10+t*12,32,8,4);e.generateTexture("water_tile",64,64),e.clear(),e.fillStyle(16556817,1),e.fillTriangle(0,64,64,64,32,0),e.generateTexture("ramp",64,64),e.clear(),e.fillStyle(9127187,1),e.fillCircle(16,16,14),e.fillStyle(6636321,1),e.fillRect(4,14,24,4),e.generateTexture("barrel",32,32),e.clear(),e.lineStyle(4,16739179,1),e.strokeCircle(16,16,12),e.generateTexture("ring",32,32),e.clear(),e.fillStyle(16729344,1),e.fillCircle(16,16,14),e.fillStyle(16737095,1),e.fillCircle(16,16,8),e.generateTexture("bumper",32,32),e.clear(),e.fillStyle(16766720,1),e.beginPath();for(let t=0;t<5;t++){const i=t*2*Math.PI/5-Math.PI/2,s=i+Math.PI/5;e.lineTo(16+Math.cos(i)*14,16+Math.sin(i)*14),e.lineTo(16+Math.cos(s)*7,16+Math.sin(s)*7)}e.closePath(),e.fillPath(),e.generateTexture("powerup_speed",32,32),e.clear(),e.fillStyle(5227511,1),e.fillCircle(16,16,14),e.fillStyle(11789820,.5),e.fillCircle(16,16,10),e.generateTexture("powerup_shield",32,32),e.clear(),e.fillStyle(7798531,1),e.fillTriangle(16,2,2,30,30,30),e.generateTexture("powerup_jump",32,32),e.clear(),e.fillStyle(30646,1),e.fillRoundedRect(0,0,256,128,20),e.fillStyle(46296,.7),e.fillRoundedRect(10,10,236,108,15),e.generateTexture("pool",256,128),e.clear(),e.fillStyle(11397364,1),e.fillCircle(4,4,4),e.generateTexture("splash_particle",8,8),e.clear(),e.fillStyle(16777215,.6),e.fillRect(0,0,2,16),e.generateTexture("speed_line",2,16),e.clear(),e.fillStyle(16739179,1),e.fillRect(0,0,6,6),e.generateTexture("confetti",6,6),e.clear(),e.fillStyle(30646,1),e.fillRoundedRect(0,0,80,80,15),e.fillStyle(46296,1),e.fillRoundedRect(4,4,72,72,12),e.generateTexture("btn_base",80,80),e.clear(),e.fillStyle(16777215,1),e.fillTriangle(50,10,50,60,15,35),e.generateTexture("arrow_left",64,64),e.clear(),e.fillStyle(16777215,1),e.fillTriangle(14,10,14,60,49,35),e.generateTexture("arrow_right",64,64),e.clear(),e.fillStyle(16777215,1),e.fillTriangle(32,8,8,56,56,56),e.generateTexture("jump_icon",64,64),e.clear(),e.fillStyle(8900331,1),e.fillRect(0,0,390,256),e.fillStyle(16777215,.4),e.fillEllipse(80,60,60,20),e.fillEllipse(200,40,80,25),e.fillEllipse(300,80,50,15),e.generateTexture("bg_sky",390,256),e.clear(),e.fillStyle(2976335,1),e.fillTriangle(0,200,100,50,200,200),e.fillTriangle(120,200,250,30,390,200),e.fillStyle(4231532,1),e.fillTriangle(50,200,180,80,320,200),e.generateTexture("bg_mountains",390,200),e.clear(),e.fillStyle(38599,1),e.fillRect(0,0,16,64),e.fillStyle(4770532,1),e.fillRect(4,0,8,64),e.generateTexture("side_rail",16,64),e.clear(),e.lineStyle(3,5227511,.7),e.strokeCircle(20,20,18),e.generateTexture("shield_effect",40,40),e.clear(),e.fillStyle(0,.5),e.fillRoundedRect(0,0,60,120,5),e.generateTexture("minimap_bg",60,120),e.destroy()}generatePlayerTextures(e){[16739179,5164484,16770669,9822675,15958401,11179738,16564041,3065014].forEach((i,s)=>{e.clear(),e.fillStyle(i,1),e.fillCircle(20,16,12),e.fillStyle(i,.8),e.fillEllipse(20,32,20,12),e.fillStyle(16777215,.9),e.fillEllipse(20,36,28,8),e.lineStyle(2,i,1),e.strokeEllipse(20,36,28,8),e.fillStyle(0,1),e.fillCircle(16,14,2),e.fillCircle(24,14,2),e.lineStyle(1,0,1),e.beginPath(),e.arc(20,18,4,0,Math.PI,!1),e.strokePath(),e.generateTexture(`player_${s}`,40,48)})}}const v={masterVolume:.8,musicVolume:.6,sfxVolume:.8,muted:!1,controlScheme:"buttons",quality:"medium",botCount:7,matchLength:45,tiltEnabled:!1},_={totalRuns:0,totalWins:0,bestTime:999999,totalScore:0,achievements:[],unlockedSkins:[0]},P=[16739179,5164484,16770669,9822675,15958401,11179738,16564041,3065014],w={STATS:"aquapark_stats",SETTINGS:"aquapark_settings",REPLAYS_INDEX:"aquapark_replays_index",REPLAY_PREFIX:"aquapark_replay_"};class x{static async saveStats(e){try{localStorage.setItem(w.STATS,JSON.stringify(e))}catch{}}static async loadStats(){try{const e=localStorage.getItem(w.STATS);if(e)return{..._,...JSON.parse(e)}}catch{}return{..._}}static async saveSettings(e){try{localStorage.setItem(w.SETTINGS,JSON.stringify(e))}catch{}}static async loadSettings(){try{const e=localStorage.getItem(w.SETTINGS);if(e)return{...v,...JSON.parse(e)}}catch{}return{...v}}static async saveReplay(e,t){try{localStorage.setItem(w.REPLAY_PREFIX+e,JSON.stringify(t));const i=await this.listReplays(),s={id:e,date:Date.now(),mode:t.mode,score:0,position:0,duration:t.frames.length/60};i.unshift(s),i.length>20&&i.splice(20).forEach(a=>{try{localStorage.removeItem(w.REPLAY_PREFIX+a.id)}catch{}}),localStorage.setItem(w.REPLAYS_INDEX,JSON.stringify(i))}catch{}}static async loadReplay(e){try{const t=localStorage.getItem(w.REPLAY_PREFIX+e);if(t)return JSON.parse(t)}catch{}return null}static async listReplays(){try{const e=localStorage.getItem(w.REPLAYS_INDEX);if(e)return JSON.parse(e)}catch{}return[]}static async deleteReplay(e){try{localStorage.removeItem(w.REPLAY_PREFIX+e);const i=(await this.listReplays()).filter(s=>s.id!==e);localStorage.setItem(w.REPLAYS_INDEX,JSON.stringify(i))}catch{}}static async clearAll(){try{const e=[];for(let t=0;t<localStorage.length;t++){const i=localStorage.key(t);i&&i.startsWith("aquapark_")&&e.push(i)}e.forEach(t=>localStorage.removeItem(t))}catch{}}static async getStorageUsage(){try{let e=0;for(let t=0;t<localStorage.length;t++){const i=localStorage.key(t);if(i&&i.startsWith("aquapark_")){const s=localStorage.getItem(i);s&&(e+=s.length*2)}}return e}catch{return 0}}}class U extends y.Scene{constructor(){super({key:"MenuScene"})}async create(){this.settings=await x.loadSettings();const{width:e,height:t}=this.cameras.main,i=this.add.graphics();i.fillGradientStyle(30646,30646,46296,9494767,1),i.fillRect(0,0,e,t),this.createWaterAnimation(e,t);const s={fontSize:"48px",fontFamily:"Arial, sans-serif",color:"#ffffff",stroke:"#0077B6",strokeThickness:6,shadow:{offsetX:3,offsetY:3,color:"#003566",blur:8,fill:!0}},n=this.add.text(e/2,80,"AQUA PARK",s).setOrigin(.5);this.tweens.add({targets:n,y:90,duration:1500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.add.text(e/2,130,"Water Slide Racing",{fontSize:"18px",fontFamily:"Arial, sans-serif",color:"#CAF0F8"}).setOrigin(.5),[{label:"Classic Race",mode:"classic",y:240},{label:"Time Trial",mode:"timeTrial",y:320},{label:"Chaos Mode",mode:"chaos",y:400},{label:"Custom Game",mode:"custom",y:480}].forEach(({label:o,mode:c,y:u})=>{this.createMenuButton(e/2,u,o,()=>{this.scene.start("GameScene",{mode:c,settings:this.settings})})}),this.createSmallButton(e/2-80,600,"Settings",()=>{this.scene.start("SettingsScene")}),this.createSmallButton(e/2+80,600,"Replays",()=>{this.scene.start("ReplayScene",{action:"list"})});const r=await x.loadStats();this.add.text(e/2,700,`Races: ${r.totalRuns}  Wins: ${r.totalWins}`,{fontSize:"14px",fontFamily:"Arial, sans-serif",color:"#CAF0F8"}).setOrigin(.5),this.add.text(e/2,t-20,"v1.0.0",{fontSize:"10px",color:"#CAF0F8",fontFamily:"Arial, sans-serif"}).setOrigin(.5)}createMenuButton(e,t,i,s){const n=this.add.graphics();n.fillStyle(30646,.9),n.fillRoundedRect(e-120,t-25,240,50,15),n.lineStyle(2,13299960,1),n.strokeRoundedRect(e-120,t-25,240,50,15);const a=this.add.text(e,t,i,{fontSize:"22px",fontFamily:"Arial, sans-serif",color:"#ffffff"}).setOrigin(.5),r=this.add.zone(e,t,240,50).setInteractive();r.on("pointerdown",()=>{this.tweens.add({targets:[n,a],scaleX:.95,scaleY:.95,duration:100,yoyo:!0,onComplete:s})}),r.on("pointerover",()=>{n.clear(),n.fillStyle(38599,.95),n.fillRoundedRect(e-120,t-25,240,50,15),n.lineStyle(2,16777215,1),n.strokeRoundedRect(e-120,t-25,240,50,15)}),r.on("pointerout",()=>{n.clear(),n.fillStyle(30646,.9),n.fillRoundedRect(e-120,t-25,240,50,15),n.lineStyle(2,13299960,1),n.strokeRoundedRect(e-120,t-25,240,50,15)})}createSmallButton(e,t,i,s){const n=this.add.graphics();n.fillStyle(13670,.8),n.fillRoundedRect(e-65,t-20,130,40,10),this.add.text(e,t,i,{fontSize:"16px",fontFamily:"Arial, sans-serif",color:"#CAF0F8"}).setOrigin(.5),this.add.zone(e,t,130,40).setInteractive().on("pointerdown",s)}createWaterAnimation(e,t){const i=t-100;for(let s=0;s<3;s++){const n=this.add.graphics();n.fillStyle(9494767,.3+s*.15),n.fillEllipse(e/2,i+s*20,e+40,80),this.tweens.add({targets:n,x:10+s*5,duration:2e3+s*500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}}}const m={FIXED_DT:1/60,LANE_WIDTH:50,FORWARD_ACCEL:120,MAX_FORWARD_SPEED:400,LATERAL_SPEED:200,LATERAL_ACCEL:800,LATERAL_FRICTION:600,JUMP_DURATION:.5,STUN_DURATION:.4,COLLISION_PUSH:150,COLLISION_RADIUS:20,SPEED_BOOST_MULT:1.5,SPEED_BOOST_DURATION:3,SHIELD_DURATION:4,JUMP_BOOST_MULT:1.5,JUMP_BOOST_DURATION:5,LANDING_BOOST:30,SLIDE_WIDTH:250};class H{constructor(e){this.seed=e}next(){return this.seed=this.seed*1664525+1013904223&4294967295,(this.seed>>>0)/4294967295}nextInt(e,t){return Math.floor(this.next()*(t-e))+e}nextFloat(e,t){return this.next()*(t-e)+e}getSeed(){return this.seed}}function b(l,e,t,i,s,n){return{id:l,name:e,x:t*m.LANE_WIDTH+m.LANE_WIDTH/2,y:0,lane:t,forwardSpeed:0,lateralSpeed:0,distanceTraveled:0,isJumping:!1,jumpTimer:0,stunTimer:0,hasShield:!1,shieldTimer:0,speedBoostTimer:0,jumpBoostTimer:0,isBot:i,botProfile:n,skinIndex:s,score:0,finished:!1,finishTime:0,finishPosition:0}}function D(l,e,t,i){if(l.finished||(l.stunTimer>0&&(l.stunTimer-=i,l.stunTimer<0&&(l.stunTimer=0)),l.shieldTimer>0&&(l.shieldTimer-=i,l.shieldTimer<=0&&(l.hasShield=!1,l.shieldTimer=0)),l.speedBoostTimer>0&&(l.speedBoostTimer-=i,l.speedBoostTimer<0&&(l.speedBoostTimer=0)),l.jumpBoostTimer>0&&(l.jumpBoostTimer-=i,l.jumpBoostTimer<0&&(l.jumpBoostTimer=0)),l.stunTimer>0))return;const s=-t.slope*50,n=l.speedBoostTimer>0?m.SPEED_BOOST_MULT:1;l.forwardSpeed+=(m.FORWARD_ACCEL+s)*i,l.forwardSpeed=Math.min(l.forwardSpeed*n,m.MAX_FORWARD_SPEED),l.forwardSpeed*=t.friction;const a=(e.left?-1:0)+(e.right?1:0);a!==0?(l.lateralSpeed+=a*m.LATERAL_ACCEL*i,l.lateralSpeed=Math.max(-200,Math.min(m.LATERAL_SPEED,l.lateralSpeed))):l.lateralSpeed>0?(l.lateralSpeed-=m.LATERAL_FRICTION*i,l.lateralSpeed<0&&(l.lateralSpeed=0)):l.lateralSpeed<0&&(l.lateralSpeed+=m.LATERAL_FRICTION*i,l.lateralSpeed>0&&(l.lateralSpeed=0)),e.jump&&!l.isJumping&&(l.isJumping=!0,l.jumpTimer=l.jumpBoostTimer>0?m.JUMP_DURATION*m.JUMP_BOOST_MULT:m.JUMP_DURATION),l.isJumping&&(l.jumpTimer-=i,l.jumpTimer<=0&&(l.isJumping=!1,l.jumpTimer=0,l.forwardSpeed+=m.LANDING_BOOST)),l.x+=l.lateralSpeed*i,l.distanceTraveled+=l.forwardSpeed*i;const r=t.lanes*m.LANE_WIDTH/2,o=m.SLIDE_WIDTH/2;l.x=Math.max(o-r+10,Math.min(o+r-10,l.x)),l.lane=Math.floor(l.x/m.LANE_WIDTH),l.lane=Math.max(0,Math.min(t.lanes-1,l.lane))}function V(l,e){if(l.isJumping||e.isJumping||l.finished||e.finished)return!1;const t=l.x-e.x,i=l.distanceTraveled-e.distanceTraveled;return Math.sqrt(t*t+i*i)<m.COLLISION_RADIUS*2}function Y(l,e){if(l.hasShield&&e.hasShield)return;const i=l.x-e.x>0?1:-1;l.hasShield||(l.lateralSpeed+=i*m.COLLISION_PUSH,l.stunTimer=m.STUN_DURATION),e.hasShield||(e.lateralSpeed-=i*m.COLLISION_PUSH,e.stunTimer=m.STUN_DURATION)}function G(l,e){if(!l.hasShield)switch(e){case"barrel":l.forwardSpeed*=.5,l.stunTimer=m.STUN_DURATION*1.5;break;case"ring":l.forwardSpeed*=.7,l.lateralSpeed*=-.5;break;case"bumper":l.lateralSpeed+=(l.x>m.SLIDE_WIDTH/2?1:-1)*m.COLLISION_PUSH*1.5,l.stunTimer=m.STUN_DURATION;break}}function $(l,e){switch(e){case"speed_boost":l.speedBoostTimer=m.SPEED_BOOST_DURATION;break;case"shield":l.hasShield=!0,l.shieldTimer=m.SHIELD_DURATION;break;case"jump_boost":l.jumpBoostTimer=m.JUMP_BOOST_DURATION;break}}function k(l,e,t,i){const s=Math.max(0,(e-l+1)*100),n=Math.max(0,Math.floor((i-t)*10));return s+n}const J={casual:{type:"casual",name:"Casual",targetSpeedFactor:.7,boostSeekRange:100,optimalLineWeight:.3,collisionAggression:.1,collisionAvoidance:.7,jumpFrequency:.2,jumpTimingPrecision:.3,riskTolerance:.2,obstacleAvoidRange:120,steeringJitter:.15,reactionDelay:8,mistakeChance:.1,adaptiveness:.1},aggressive:{type:"aggressive",name:"Aggressive",targetSpeedFactor:.85,boostSeekRange:150,optimalLineWeight:.4,collisionAggression:.8,collisionAvoidance:.2,jumpFrequency:.4,jumpTimingPrecision:.5,riskTolerance:.8,obstacleAvoidRange:80,steeringJitter:.1,reactionDelay:4,mistakeChance:.08,adaptiveness:.3},speedster:{type:"speedster",name:"Speedster",targetSpeedFactor:.95,boostSeekRange:200,optimalLineWeight:.8,collisionAggression:.2,collisionAvoidance:.5,jumpFrequency:.3,jumpTimingPrecision:.8,riskTolerance:.5,obstacleAvoidRange:150,steeringJitter:.05,reactionDelay:2,mistakeChance:.04,adaptiveness:.2},trickster:{type:"trickster",name:"Trickster",targetSpeedFactor:.75,boostSeekRange:120,optimalLineWeight:.3,collisionAggression:.3,collisionAvoidance:.3,jumpFrequency:.8,jumpTimingPrecision:.7,riskTolerance:.7,obstacleAvoidRange:100,steeringJitter:.12,reactionDelay:5,mistakeChance:.06,adaptiveness:.2},adaptive:{type:"adaptive",name:"Adaptive",targetSpeedFactor:.8,boostSeekRange:160,optimalLineWeight:.6,collisionAggression:.4,collisionAvoidance:.4,jumpFrequency:.4,jumpTimingPrecision:.6,riskTolerance:.5,obstacleAvoidRange:130,steeringJitter:.08,reactionDelay:3,mistakeChance:.05,adaptiveness:.9}};class q{constructor(e,t){this.state="race",this.stateTimer=0,this.reactionBuffer=[],this.targetLane=2,this.frameCount=0,this.profile=J[e];for(let i=0;i<this.profile.reactionDelay;i++)this.reactionBuffer.push({left:!1,right:!1,jump:!1})}update(e,t,i,s){this.frameCount++,this.stateTimer++,this.updateState(e,t,i,s);const n=this.generateInput(e,t,i,s);this.reactionBuffer.push(n);const a=this.reactionBuffer.shift();return s.next()<this.profile.steeringJitter&&(s.next()>.5?a.left=!a.left:a.right=!a.right),s.next()<this.profile.mistakeChance/60&&(a.left=s.next()>.5,a.right=!a.left),a}updateState(e,t,i,s){if(e.stunTimer>0){this.state="recover",this.stateTimer=0;return}const n=t.filter(a=>a.id!==e.id&&!a.finished&&Math.abs(a.distanceTraveled-e.distanceTraveled)<100&&Math.abs(a.x-e.x)<m.SLIDE_WIDTH);if(this.profile.adaptiveness>.5){const a=t.find(r=>!r.isBot);a&&a.distanceTraveled>e.distanceTraveled+100&&(this.profile.targetSpeedFactor=Math.min(1,this.profile.targetSpeedFactor+.1),this.profile.riskTolerance=Math.min(1,this.profile.riskTolerance+.1))}this.state==="recover"&&e.stunTimer<=0&&(this.state="race",this.stateTimer=0),n.length>0&&this.profile.collisionAggression>s.next()?(this.state="chase",this.stateTimer=0):this.state==="chase"&&(n.length===0||this.stateTimer>120)&&(this.state="race",this.stateTimer=0),(e.speedBoostTimer>0||e.hasShield||e.jumpBoostTimer>0)&&s.next()<.1&&(this.state="usePowerup",this.stateTimer=0),this.stateTimer>180&&(this.state="race",this.stateTimer=0)}generateInput(e,t,i,s){const n={left:!1,right:!1,jump:!1};switch(this.state){case"race":return this.raceInput(e,i,s);case"avoidObstacle":return this.avoidObstacleInput(e,i,s);case"chase":return this.chaseInput(e,t,s);case"usePowerup":return this.powerupInput(e,s);case"recover":return n}}raceInput(e,t,i){const s={left:!1,right:!1,jump:!1};this.targetLane=this.scoreLanes(e,t,i);const a=this.targetLane*m.LANE_WIDTH+m.LANE_WIDTH/2-e.x,r=10;return a<-r?s.left=!0:a>r&&(s.right=!0),(t.type==="ramp"&&i.next()<this.profile.jumpTimingPrecision||i.next()<this.profile.jumpFrequency/120)&&(s.jump=!0),s}avoidObstacleInput(e,t,i){const s={left:!1,right:!1,jump:!1},r=this.findSafestLane(e,t)*m.LANE_WIDTH+m.LANE_WIDTH/2-e.x;return r<-5?s.left=!0:r>5&&(s.right=!0),i.next()<this.profile.riskTolerance*.5&&(s.jump=!0),s}chaseInput(e,t,i){const s={left:!1,right:!1,jump:!1},n=t.filter(a=>a.id!==e.id&&!a.finished).sort((a,r)=>{const o=Math.abs(a.distanceTraveled-e.distanceTraveled)+Math.abs(a.x-e.x),c=Math.abs(r.distanceTraveled-e.distanceTraveled)+Math.abs(r.x-e.x);return o-c});if(n.length>0){const r=n[0].x-e.x;this.profile.collisionAggression>.5?r<-5?s.left=!0:r>5&&(s.right=!0):r<-5?s.right=!0:r>5&&(s.left=!0)}return i.next()<.02&&(s.jump=!0),s}powerupInput(e,t){const i={left:!1,right:!1,jump:!1};if(e.jumpBoostTimer>0&&t.next()<.05&&(i.jump=!0),e.speedBoostTimer>0){const s=m.SLIDE_WIDTH/2;e.x<s-10?i.right=!0:e.x>s+10&&(i.left=!0)}return i}scoreLanes(e,t,i){const s=t.lanes,n=[];for(let o=0;o<s;o++){let c=0;const u=Math.abs(o-Math.floor(s/2));c+=(s-u)*this.profile.optimalLineWeight*10,t.obstacles.forEach(h=>{h.lane===o&&(c-=20*this.profile.collisionAvoidance)}),t.powerups.forEach(h=>{h.lane===o&&(c+=15*this.profile.boostSeekRange/200)}),c+=i.nextFloat(-5,5),n.push(c)}let a=0,r=-1/0;return n.forEach((o,c)=>{o>r&&(r=o,a=c)}),a}findSafestLane(e,t){const i=t.lanes,s=new Array(i).fill(0);t.obstacles.forEach(r=>{r.lane>=0&&r.lane<i&&(s[r.lane]+=10)});let n=e.lane,a=1/0;return s.forEach((r,o)=>{r<a&&(a=r,n=o)}),n}getState(){return this.state}getProfile(){return{...this.profile}}}function K(){return[T("straight",400,5,.98,-.5,[{type:"barrel",lane:1,position:.5},{type:"barrel",lane:3,position:.7}],[{type:"speed_boost",lane:2,position:.3}]),T("curve_left",300,5,.97,-.6,[{type:"ring",lane:0,position:.4},{type:"bumper",lane:4,position:.6,moving:!0,moveRange:30}],[]),T("ramp",200,5,.99,-1,[],[{type:"jump_boost",lane:2,position:.5}]),T("straight",500,5,.98,-.4,[{type:"barrel",lane:0,position:.2},{type:"barrel",lane:2,position:.3},{type:"barrel",lane:4,position:.4},{type:"bumper",lane:1,position:.6,moving:!0,moveRange:40},{type:"ring",lane:3,position:.8}],[{type:"speed_boost",lane:1,position:.15},{type:"shield",lane:3,position:.5}]),T("narrow",200,3,.96,-.7,[{type:"bumper",lane:1,position:.5,moving:!0,moveRange:20}],[{type:"speed_boost",lane:0,position:.3}]),T("curve_right",350,5,.97,-.5,[{type:"ring",lane:2,position:.3},{type:"barrel",lane:4,position:.5},{type:"barrel",lane:0,position:.7}],[{type:"jump_boost",lane:2,position:.6}]),T("ramp",250,5,.99,-1.2,[],[{type:"speed_boost",lane:2,position:.4}]),T("gap",150,5,.95,-.3,[{type:"ring",lane:1,position:.5},{type:"ring",lane:3,position:.5}],[]),T("straight",600,5,.98,-.8,[{type:"bumper",lane:0,position:.2,moving:!0,moveRange:50},{type:"bumper",lane:4,position:.3,moving:!0,moveRange:50},{type:"barrel",lane:2,position:.5},{type:"ring",lane:1,position:.7},{type:"ring",lane:3,position:.7},{type:"barrel",lane:2,position:.85}],[{type:"speed_boost",lane:2,position:.1},{type:"shield",lane:0,position:.6},{type:"speed_boost",lane:4,position:.9}]),T("splitter",300,5,.97,-.6,[{type:"bumper",lane:2,position:.4}],[{type:"speed_boost",lane:0,position:.5},{type:"speed_boost",lane:4,position:.5}]),T("straight",400,5,.99,-1,[{type:"barrel",lane:1,position:.3},{type:"barrel",lane:3,position:.3}],[{type:"speed_boost",lane:2,position:.5}])]}function Z(l,e,t){const i=[],s=t.matchLength*80;let n=0;const a=["straight","curve_left","curve_right","ramp","narrow","gap"];e==="chaos"&&a.push("splitter","gap","ramp");const r=T("straight",300,5,.98,-.5,[],[{type:"speed_boost",lane:2,position:.5}]);for(i.push(r),n+=300;n<s;){const o=a[l.nextInt(0,a.length)],c=l.nextInt(150,500),u=o==="narrow"?3:5,h=l.nextFloat(.95,.99),d=l.nextFloat(-1.2,-.3),p=[],f=e==="chaos"?l.nextInt(2,6):l.nextInt(0,4),S=["barrel","ring","bumper"];for(let F=0;F<f;F++)p.push({type:S[l.nextInt(0,S.length)],lane:l.nextInt(0,u),position:l.nextFloat(.1,.9),moving:e==="chaos"?l.next()>.5:l.next()>.8,moveRange:l.nextInt(20,50)});const g=[],O=l.nextInt(0,3),I=["speed_boost","shield","jump_boost"];for(let F=0;F<O;F++)g.push({type:I[l.nextInt(0,I.length)],lane:l.nextInt(0,u),position:l.nextFloat(.1,.9)});i.push(T(o,c,u,h,d,p,g)),n+=c}return i.push(T("straight",200,5,.99,-.8,[],[])),i}function T(l,e,t,i,s,n,a){return{type:l,length:e,lanes:t,friction:i,slope:s,obstacles:n,powerups:a}}class Q{constructor(e,t,i){this.input={left:!1,right:!1,jump:!1},this.swipeStartX=0,this.swipeStartY=0,this.swipeThreshold=30,this.swipeDeadzone=10,this.tiltBaseline=0,this.tiltSensitivity=15,this.scene=e,this.scheme=t,this.tiltEnabled=i,this.setupKeyboard(),t==="buttons"?this.setupButtons():t==="swipe"&&this.setupSwipe(),i&&this.setupTilt()}getInput(){var e,t;return this.cursors&&(this.cursors.left.isDown&&(this.input.left=!0),this.cursors.right.isDown&&(this.input.right=!0),this.cursors.left.isUp&&this.scheme!=="tilt"&&this.scheme!=="buttons"&&(this.input.left=!1),this.cursors.right.isUp&&this.scheme!=="tilt"&&this.scheme!=="buttons"&&(this.input.right=!1)),(e=this.spaceKey)!=null&&e.isDown&&(this.input.jump=!0),(t=this.spaceKey)!=null&&t.isUp&&this.scheme!=="buttons"&&(this.input.jump=!1),{...this.input}}setupKeyboard(){this.scene.input.keyboard&&(this.cursors=this.scene.input.keyboard.createCursorKeys(),this.spaceKey=this.scene.input.keyboard.addKey(y.Input.Keyboard.KeyCodes.SPACE))}setupButtons(){const{width:e,height:t}=this.scene.cameras.main,i=70,s=20,n=t-s-i/2;this.leftBtn=this.createButton(s+i/2,n,i,"arrow_left"),this.leftBtn.setScrollFactor(0).setDepth(950);const a=this.scene.add.zone(s+i/2,n,i,i).setInteractive().setScrollFactor(0).setDepth(951);a.on("pointerdown",()=>{this.input.left=!0}),a.on("pointerup",()=>{this.input.left=!1}),a.on("pointerout",()=>{this.input.left=!1}),this.rightBtn=this.createButton(s+i*1.8,n,i,"arrow_right"),this.rightBtn.setScrollFactor(0).setDepth(950);const r=this.scene.add.zone(s+i*1.8,n,i,i).setInteractive().setScrollFactor(0).setDepth(951);r.on("pointerdown",()=>{this.input.right=!0}),r.on("pointerup",()=>{this.input.right=!1}),r.on("pointerout",()=>{this.input.right=!1}),this.jumpBtn=this.createButton(e-s-i/2,n,i,"jump_icon"),this.jumpBtn.setScrollFactor(0).setDepth(950);const o=this.scene.add.zone(e-s-i/2,n,i,i).setInteractive().setScrollFactor(0).setDepth(951);o.on("pointerdown",()=>{this.input.jump=!0}),o.on("pointerup",()=>{this.input.jump=!1}),o.on("pointerout",()=>{this.input.jump=!1})}createButton(e,t,i,s){const n=this.scene.add.container(e,t),a=this.scene.add.graphics();a.fillStyle(30646,.6),a.fillRoundedRect(-i/2,-i/2,i,i,15),a.lineStyle(2,13299960,.5),a.strokeRoundedRect(-i/2,-i/2,i,i,15),n.add(a);const r=this.scene.add.sprite(0,0,s);return r.setDisplaySize(i*.5,i*.5),n.add(r),n}setupSwipe(){this.scene.input.on("pointerdown",n=>{this.swipeStartX=n.x,this.swipeStartY=n.y}),this.scene.input.on("pointermove",n=>{if(!n.isDown)return;const a=n.x-this.swipeStartX,r=n.y-this.swipeStartY;Math.abs(a)>this.swipeDeadzone?(this.input.left=a<-this.swipeThreshold,this.input.right=a>this.swipeThreshold):(this.input.left=!1,this.input.right=!1),r<-this.swipeThreshold*1.5&&(this.input.jump=!0)}),this.scene.input.on("pointerup",()=>{this.input.left=!1,this.input.right=!1,this.input.jump=!1});const{width:e,height:t}=this.scene.cameras.main;this.createButton(e-50,t-60,60,"jump_icon").setScrollFactor(0).setDepth(950);const s=this.scene.add.zone(e-50,t-60,60,60).setInteractive().setScrollFactor(0).setDepth(951);s.on("pointerdown",()=>{this.input.jump=!0}),s.on("pointerup",()=>{this.input.jump=!1})}setupTilt(){if("DeviceOrientationEvent"in window){const e=DeviceOrientationEvent.requestPermission;typeof e=="function"?e().then(t=>{t==="granted"&&this.addTiltListener()}).catch(()=>{}):this.addTiltListener()}}addTiltListener(){let e=!1;window.addEventListener("deviceorientation",t=>{if(t.gamma===null)return;e||(this.tiltBaseline=t.gamma,e=!0);const i=t.gamma-this.tiltBaseline;i<-this.tiltSensitivity?(this.input.left=!0,this.input.right=!1):i>this.tiltSensitivity?(this.input.left=!1,this.input.right=!0):(this.input.left=!1,this.input.right=!1)})}destroy(){var e,t,i;(e=this.leftBtn)==null||e.destroy(),(t=this.rightBtn)==null||t.destroy(),(i=this.jumpBtn)==null||i.destroy()}}class E{constructor(){this.audioContext=null,this.settings=null,this.musicOscillator=null,this.musicGain=null,this.isMusicPlaying=!1}static getInstance(){return E.instance||(E.instance=new E),E.instance}getContext(){if(!this.audioContext)try{this.audioContext=new(window.AudioContext||window.webkitAudioContext)}catch{return null}return this.audioContext}applySettings(e){if(this.settings=e,this.musicGain&&this.audioContext){const t=e.muted?0:e.masterVolume*e.musicVolume;this.musicGain.gain.setValueAtTime(t*.1,this.audioContext.currentTime)}}playMusic(){var t;if(this.isMusicPlaying)return;const e=this.getContext();if(!(!e||(t=this.settings)!=null&&t.muted))try{this.musicGain=e.createGain();const i=this.settings?this.settings.masterVolume*this.settings.musicVolume:.3;this.musicGain.gain.setValueAtTime(i*.1,e.currentTime),this.musicGain.connect(e.destination),this.musicOscillator=e.createOscillator(),this.musicOscillator.type="sine",this.musicOscillator.frequency.setValueAtTime(440,e.currentTime);const s=[440,494,523,587,659,587,523,494],n=.3;s.forEach((r,o)=>{const c=e.currentTime+o*n;this.musicOscillator.frequency.setValueAtTime(r,c)});const a=s.length*n;this.musicOscillator.connect(this.musicGain),this.musicOscillator.start(),this.scheduleLoop(e,s,n,a),this.isMusicPlaying=!0}catch{}}scheduleLoop(e,t,i,s){const n=()=>{!this.isMusicPlaying||!this.musicOscillator||(t.forEach((a,r)=>{const o=e.currentTime+r*i;try{this.musicOscillator.frequency.setValueAtTime(a,o)}catch{}}),setTimeout(n,s*1e3))};setTimeout(n,s*1e3)}stopMusic(){if(this.musicOscillator){try{this.musicOscillator.stop()}catch{}this.musicOscillator=null}this.isMusicPlaying=!1}playSfx(e){var s;const t=this.getContext();if(!t||(s=this.settings)!=null&&s.muted)return;const i=this.settings?this.settings.masterVolume*this.settings.sfxVolume:.5;if(!(i<=0))try{const n=t.createOscillator(),a=t.createGain();switch(a.gain.setValueAtTime(i*.2,t.currentTime),a.connect(t.destination),n.connect(a),e){case"jump":n.type="sine",n.frequency.setValueAtTime(600,t.currentTime),n.frequency.exponentialRampToValueAtTime(1200,t.currentTime+.15),a.gain.exponentialRampToValueAtTime(.001,t.currentTime+.2),n.start(),n.stop(t.currentTime+.2);break;case"collision":n.type="sawtooth",n.frequency.setValueAtTime(200,t.currentTime),n.frequency.exponentialRampToValueAtTime(80,t.currentTime+.15),a.gain.exponentialRampToValueAtTime(.001,t.currentTime+.2),n.start(),n.stop(t.currentTime+.2);break;case"splash":n.type="sine",n.frequency.setValueAtTime(800,t.currentTime),n.frequency.exponentialRampToValueAtTime(200,t.currentTime+.4),a.gain.exponentialRampToValueAtTime(.001,t.currentTime+.5),n.start(),n.stop(t.currentTime+.5);break;case"powerup":n.type="sine",n.frequency.setValueAtTime(523,t.currentTime),n.frequency.setValueAtTime(659,t.currentTime+.1),n.frequency.setValueAtTime(784,t.currentTime+.2),a.gain.exponentialRampToValueAtTime(.001,t.currentTime+.3),n.start(),n.stop(t.currentTime+.3);break;case"win":n.type="sine",[523,659,784,1047].forEach((o,c)=>{n.frequency.setValueAtTime(o,t.currentTime+c*.15)}),a.gain.exponentialRampToValueAtTime(.001,t.currentTime+.8),n.start(),n.stop(t.currentTime+.8);break;case"click":n.type="sine",n.frequency.setValueAtTime(800,t.currentTime),a.gain.exponentialRampToValueAtTime(.001,t.currentTime+.05),n.start(),n.stop(t.currentTime+.05);break}}catch{}}}const ee=900,L=120,M=150,R=30,te=1200,B=5;class ie extends y.Scene{constructor(){super({key:"GameScene"}),this.players=[],this.track=[],this.totalTrackLength=0,this.elapsedTime=0,this.tickCount=0,this.gameOver=!1,this.finishCount=0,this.isCountingDown=!0,this.renderSegs=[],this.worldObjects=[],this.playerInput={left:!1,right:!1,jump:!1},this.botControllers=new Map,this.replayFrames=[],this.isReplay=!1,this.replayTick=0}init(e){this.mode=e.mode||"classic",this.settings=e.settings||v,this.isReplay=!!e.replay,this.replayData=e.replay,this.players=[],this.botControllers.clear(),this.replayFrames=[],this.elapsedTime=0,this.tickCount=0,this.gameOver=!1,this.finishCount=0,this.replayTick=0,this.isCountingDown=!0,this.playerInput={left:!1,right:!1,jump:!1},this.renderSegs=[],this.worldObjects=[]}create(){var i;const{width:e,height:t}=this.cameras.main;this.seed=this.isReplay&&this.replayData?this.replayData.seed:Date.now(),this.rng=new H(this.seed),this.mode==="classic"||this.isReplay&&((i=this.replayData)==null?void 0:i.mode)==="classic"?this.track=K():this.track=Z(this.rng,this.mode,this.settings),this.totalTrackLength=this.track.reduce((s,n)=>s+n.length,0),this.buildRenderSegments(),this.buildWorldObjects(),this.createPlayers(),this.gfx=this.add.graphics(),this.createHUD(e),this.isReplay||(this.controls=new Q(this,this.settings.controlScheme,this.settings.tiltEnabled)),this.audioManager=E.getInstance(),this.audioManager.applySettings(this.settings),this.cameras.main.setBackgroundColor(8900331),this.showCountdown()}update(e,t){if(this.isCountingDown||this.gameOver)return;const i=m.FIXED_DT;if(this.elapsedTime+=i,this.tickCount++,!this.isReplay)this.playerInput=this.controls.getInput(),this.replayFrames.push({tick:this.tickCount,inputs:{...this.playerInput}});else if(this.replayData){const a=this.replayData.frames[this.replayTick];a&&(this.playerInput=a.inputs,this.replayTick++)}const s=a=>{let r=0;for(const o of this.track)if(r+=o.length,a<r)return o;return this.track[this.track.length-1]},n=this.players.find(a=>!a.isBot);D(n,this.playerInput,s(n.distanceTraveled),i),this.players.filter(a=>a.isBot&&!a.finished).forEach(a=>{const r=this.botControllers.get(a.id);if(r){const o=r.update(a,this.players,s(a.distanceTraveled),this.rng);D(a,o,s(a.distanceTraveled),i)}});for(let a=0;a<this.players.length;a++)for(let r=a+1;r<this.players.length;r++)V(this.players[a],this.players[r])&&(Y(this.players[a],this.players[r]),this.audioManager.playSfx("collision"),(!this.players[a].isBot||!this.players[r].isBot)&&this.cameras.main.shake(100,.005));if(this.checkWorldObjectCollisions(n),this.players.forEach(a=>{!a.finished&&a.distanceTraveled>=this.totalTrackLength&&(this.finishCount++,a.finished=!0,a.finishTime=this.elapsedTime,a.finishPosition=this.finishCount,a.score=k(this.finishCount,this.players.length,this.elapsedTime,this.settings.matchLength),a.isBot||this.audioManager.playSfx("splash"))}),this.elapsedTime>=this.settings.matchLength||this.players.every(a=>a.finished)){this.players.forEach(a=>{a.finished||(this.finishCount++,a.finished=!0,a.finishTime=this.elapsedTime,a.finishPosition=this.finishCount,a.score=k(this.finishCount,this.players.length,this.elapsedTime,this.settings.matchLength))}),this.endGame();return}this.render3D(n),this.updateHUD(n)}buildRenderSegments(){this.renderSegs=[];let e=0,t=0,i=0;const s={straight:0,curve_left:-3,curve_right:3,ramp:0,gap:0,splitter:0,narrow:0};for(;e<this.totalTrackLength+M*R;){for(;t<this.track.length-1&&e>=i+this.track[t].length;)i+=this.track[t].length,t++;const n=this.track[Math.min(t,this.track.length-1)],a=n.length>0?(e-i)/n.length:0,r=s[n.type]||0,o=n.slope||0,c=Math.floor(e/R)%2===0,u=c?46296:38599,h=c?4770532:30646;this.renderSegs.push({worldZ:e,screenX:0,screenY:0,screenW:0,scale:0,curve:r,slope:o,color1:u,color2:h,clip:0,segmentIndex:t,segFraction:a}),e+=R}}buildWorldObjects(){this.worldObjects=[];let e=0;this.track.forEach(t=>{t.obstacles.forEach(i=>{const s=i.lane/(t.lanes-1)*2-1;this.worldObjects.push({distance:e+i.position*t.length,laneOffset:s*.8,type:"obstacle",collected:!1,obstacleType:i.type})}),t.powerups.forEach(i=>{const s=i.lane/(t.lanes-1)*2-1;this.worldObjects.push({distance:e+i.position*t.length,laneOffset:s*.8,type:"powerup",collected:!1,powerupType:i.type})}),e+=t.length})}createPlayers(){var n;const e=this.settings.botCount,t=((n=this.track[0])==null?void 0:n.lanes)||5,i=b("player","You",Math.floor(t/2),!1,0);this.players.push(i);const s=["casual","aggressive","speedster","trickster","adaptive"];for(let a=0;a<e;a++){const r=a%t,o=s[a%s.length],c=b(`bot_${a}`,`Bot ${a+1}`,r,!0,(a+1)%8,o);this.players.push(c),this.botControllers.set(c.id,new q(o,this.rng))}}checkWorldObjectCollisions(e){var i;const t=((i=this.track[0])==null?void 0:i.lanes)||5;this.worldObjects.forEach(s=>{s.collected||this.players.forEach(n=>{if(n.finished||n.isJumping||Math.abs(n.distanceTraveled-s.distance)>30)return;const r=t*m.LANE_WIDTH/2,o=m.SLIDE_WIDTH/2,c=(n.x-o)/r;Math.abs(c-s.laneOffset)>.35||(s.type==="obstacle"&&s.obstacleType?(n.hasShield||G(n,s.obstacleType),s.collected=!0,n.isBot||this.audioManager.playSfx("collision")):s.type==="powerup"&&s.powerupType&&($(n,s.powerupType),s.collected=!0,n.isBot||this.audioManager.playSfx("powerup")))})})}render3D(e){const{width:t,height:i}=this.cameras.main,s=this.gfx;s.clear(),this.drawSky(s,t,i);const n=e.distanceTraveled;this.getPlayerScreenX(e);const a=Math.max(0,Math.floor(n/R)),r=Math.min(this.renderSegs.length-1,a+M);let o=i,c=0,u=0;for(let h=a;h<=r;h++){const d=this.renderSegs[h];if(!d)continue;const p=n,f=d.worldZ-p;if(f<=0)continue;const S=L/f;d.scale=S,d.screenX=t/2+c*S*t,d.screenY=i/2-ee*S+u*S*i,d.screenW=te/2*S,d.clip=o,c+=d.curve*R*4e-4,u+=d.slope*R*3e-4}for(let h=r;h>a;h--){const d=this.renderSegs[h],p=this.renderSegs[h-1];if(!d||!p||d.scale<=0||p.scale<=0||p.screenY>=d.clip)continue;const f=Math.max(0,p.screenY),S=Math.min(i,d.screenY);if(f>=S)continue;s.fillStyle(h%2===0?1092176:39236,1),s.fillRect(0,f,t,S-f),this.drawTrapezoid(s,p.screenX,p.screenW,f,d.screenX,d.screenW,S,d.color1);const g=p.screenW*.02,O=d.screenW*.02;if(this.drawTrapezoid(s,p.screenX,g,f,d.screenX,O,S,16777215),h%4<2)for(let A=1;A<B;A++){const C=A/B*2-1,W=p.screenW*.01,N=d.screenW*.01,j=p.screenX+C*p.screenW,z=d.screenX+C*d.screenW;this.drawTrapezoid(s,j,W,f,z,N,S,4770532)}const I=p.screenW*.08,F=d.screenW*.08;if(this.drawTrapezoid(s,p.screenX-p.screenW-I/2,I,f,d.screenX-d.screenW-F/2,F,S,d.color2),this.drawTrapezoid(s,p.screenX+p.screenW+I/2,I,f,d.screenX+d.screenW+F/2,F,S,d.color2),h%6===0){const A=.15+Math.sin(this.elapsedTime*3+h)*.1;s.fillStyle(11397364,A),this.fillTrapezoid(s,p.screenX,p.screenW*.9,f,d.screenX,d.screenW*.9,S)}}this.drawWorldObjects(s,e,a,r,t,i),this.drawPlayers(s,e,t,i),this.drawFinishLine(s,e,t,i),this.drawWaterSplash(s,e,t,i)}drawSky(e,t,i){const n=i/2;for(let c=0;c<8;c++){const u=c/8,h=Math.floor(72+101*u),d=Math.floor(202+30*u),p=Math.floor(228+16*u),f=h<<16|d<<8|p;e.fillStyle(f,1),e.fillRect(0,n/8*c,t,n/8+1)}e.fillStyle(16777215,.5);const a=this.elapsedTime*5;e.fillEllipse((80+a)%(t+100)-50,60,70,22),e.fillEllipse((220+a*.7)%(t+100)-50,40,90,28),e.fillEllipse((350+a*.5)%(t+100)-50,80,55,18),e.fillStyle(2976335,1);const r=i*.25,o=i/2-r*.3;e.fillTriangle(0,o+r,t*.25,o,t*.5,o+r),e.fillStyle(4231532,1),e.fillTriangle(t*.3,o+r,t*.6,o-r*.15,t*.9,o+r),e.fillStyle(5420936,1),e.fillTriangle(t*.15,o+r,t*.45,o+r*.3,t*.75,o+r)}drawTrapezoid(e,t,i,s,n,a,r,o){e.fillStyle(o,1),e.fillTriangle(t-i,s,t+i,s,n+a,r),e.fillTriangle(t-i,s,n-a,r,n+a,r)}fillTrapezoid(e,t,i,s,n,a,r){e.fillTriangle(t-i,s,t+i,s,n+a,r),e.fillTriangle(t-i,s,n-a,r,n+a,r)}drawWorldObjects(e,t,i,s,n,a){const r=t.distanceTraveled;this.worldObjects.filter(c=>{if(c.collected)return!1;const u=c.distance-r;return u>0&&u<M*R}).sort((c,u)=>u.distance-c.distance).forEach(c=>{const u=Math.floor(c.distance/R);if(u<i||u>=s||u>=this.renderSegs.length)return;const h=this.renderSegs[u];if(!h||h.scale<=0||h.screenY>a||h.screenY<0)return;const d=h.screenX+c.laneOffset*h.screenW,p=h.screenY,f=h.scale*400;if(!(f<2)){if(c.type==="obstacle"){const g={barrel:9127187,ring:16729156,bumper:16737792}[c.obstacleType||"barrel"]||9127187;e.fillStyle(g,1),e.fillCircle(d,p-f/2,f),e.fillStyle(16777215,.3),e.fillCircle(d-f*.3,p-f*.8,f*.3)}else if(c.type==="powerup"){const g={speed_boost:16766720,shield:5227511,jump_boost:7798531}[c.powerupType||"speed_boost"]||16766720;e.fillStyle(g,.3),e.fillCircle(d,p-f/2,f*1.8),e.fillStyle(g,1),e.fillCircle(d,p-f/2,f),e.fillStyle(16777215,.8),e.fillCircle(d,p-f*.8,f*.3)}}})}drawPlayers(e,t,i,s){var u;const n=t.distanceTraveled,r=(((u=this.track[0])==null?void 0:u.lanes)||5)*m.LANE_WIDTH/2,o=m.SLIDE_WIDTH/2;[...this.players].filter(h=>!h.finished||Math.abs(h.distanceTraveled-n)<M*R).sort((h,d)=>d.distanceTraveled-h.distanceTraveled).forEach(h=>{const d=h.distanceTraveled-n;let p,f,S;if(h.id===t.id)p=i/2+this.getPlayerScreenX(t)*i*.3,f=s*.78,S=1,h.isJumping&&(f-=30);else{if(d<=-50||d>M*R)return;const I=Math.max(10,d+50);if(S=L/I,S<.03)return;const F=Math.floor(h.distanceTraveled/R),A=this.renderSegs[F];if(!A)return;const C=(h.x-o)/r;if(p=A.screenX+C*A.screenW,f=A.screenY,f<0||f>s)return;h.isJumping&&(f-=15*S*20)}const g=S*350;if(g<3)return;const O=P[h.skinIndex]||16739179;e.fillStyle(16777215,.85),e.fillEllipse(p,f,g*1.4,g*.5),e.lineStyle(Math.max(1,g*.08),O,1),e.strokeEllipse(p,f,g*1.4,g*.5),e.fillStyle(O,1),e.fillEllipse(p,f-g*.5,g*.7,g*.6),e.fillStyle(O,1),e.fillCircle(p,f-g*1,g*.45),g>8&&(e.fillStyle(0,1),e.fillCircle(p-g*.15,f-g*1.05,g*.07),e.fillCircle(p+g*.15,f-g*1.05,g*.07),e.lineStyle(Math.max(1,g*.04),0,1),e.beginPath(),e.arc(p,f-g*.85,g*.15,0,Math.PI,!1),e.strokePath()),h.hasShield&&(e.lineStyle(2,5227511,.6),e.strokeCircle(p,f-g*.5,g*1.2)),h.stunTimer>0&&Math.floor(this.elapsedTime*10)%2===0&&(e.fillStyle(16777215,.4),e.fillCircle(p,f-g*.5,g*.8)),h.speedBoostTimer>0&&(e.fillStyle(16766720,.3),e.fillEllipse(p,f+g*.3,g*.4,g*1.5)),h.isBot&&g>12})}drawFinishLine(e,t,i,s){const n=this.totalTrackLength-t.distanceTraveled;if(n<=0||n>M*R)return;const a=Math.floor(this.totalTrackLength/R),r=this.renderSegs[a];if(!r||r.screenY<0||r.screenY>s)return;const o=r.screenY,c=r.screenW*2,u=Math.max(3,r.scale*100),h=10,d=c/h;for(let p=0;p<h;p++){const f=r.screenX-c/2+p*d;e.fillStyle(p%2===0?16777215:0,1),e.fillRect(f,o-u,d,u/2),e.fillStyle(p%2===0?0:16777215,1),e.fillRect(f,o-u/2,d,u/2)}}drawWaterSplash(e,t,i,s){if(t.forwardSpeed<m.MAX_FORWARD_SPEED*.3)return;const n=i/2+this.getPlayerScreenX(t)*i*.3,a=s*.82,r=Math.min(1,t.forwardSpeed/m.MAX_FORWARD_SPEED),o=Math.floor(r*6);for(let c=0;c<o;c++){const u=-Math.PI/2+(Math.random()-.5)*Math.PI*.8,h=10+Math.random()*25*r,d=n+Math.cos(u)*h,p=a+Math.sin(u)*h*.5,f=2+Math.random()*3;e.fillStyle(11397364,.6),e.fillCircle(d,p,f)}if(r>.7){e.lineStyle(1,16777215,.3*r);for(let c=0;c<4;c++){const u=n+(Math.random()-.5)*60,h=a-20-Math.random()*30;e.lineBetween(u,h,u,h+15+Math.random()*15)}}}getPlayerScreenX(e){var n;const i=(((n=this.track[0])==null?void 0:n.lanes)||5)*m.LANE_WIDTH/2,s=m.SLIDE_WIDTH/2;return(e.x-s)/i}createHUD(e){this.hudContainer=this.add.container(0,0).setScrollFactor(0).setDepth(900);const t=this.add.graphics();t.fillStyle(0,.5),t.fillRect(0,0,e,50),this.hudContainer.add(t),this.posText=this.add.text(15,12,"#-",{fontSize:"22px",fontFamily:"Arial",color:"#FFD700",fontStyle:"bold"}),this.hudContainer.add(this.posText),this.timeText=this.add.text(e/2,12,"0:00",{fontSize:"18px",fontFamily:"Arial",color:"#FFFFFF"}).setOrigin(.5,0),this.hudContainer.add(this.timeText),this.speedText=this.add.text(e-15,12,"0 km/h",{fontSize:"16px",fontFamily:"Arial",color:"#90E0EF"}).setOrigin(1,0),this.hudContainer.add(this.speedText),this.progressBar=this.add.graphics(),this.hudContainer.add(this.progressBar),this.powerupText=this.add.text(e/2,38,"",{fontSize:"12px",fontFamily:"Arial",color:"#FFD700"}).setOrigin(.5,0),this.hudContainer.add(this.powerupText)}updateHUD(e){const t=this.cameras.main.width,i=this.players.filter(r=>r.distanceTraveled>e.distanceTraveled).length+1;this.posText.setText(`#${i}`);const s=Math.floor(this.elapsedTime/60),n=Math.floor(this.elapsedTime%60);this.timeText.setText(`${s}:${n.toString().padStart(2,"0")}`),this.speedText.setText(`${Math.floor(e.forwardSpeed)} km/h`),this.speedText.setColor(e.speedBoostTimer>0?"#FFD700":e.hasShield?"#4FC3F7":"#90E0EF");const a=Math.min(1,e.distanceTraveled/this.totalTrackLength);this.progressBar.clear(),this.progressBar.fillStyle(13670,.8),this.progressBar.fillRect(0,0,t,4),this.progressBar.fillStyle(46296,1),this.progressBar.fillRect(0,0,t*a,4),e.speedBoostTimer>0?this.powerupText.setText(`SPEED BOOST ${Math.ceil(e.speedBoostTimer)}s`):e.hasShield?this.powerupText.setText(`SHIELD ${Math.ceil(e.shieldTimer)}s`):e.jumpBoostTimer>0?this.powerupText.setText(`JUMP BOOST ${Math.ceil(e.jumpBoostTimer)}s`):this.powerupText.setText("")}showCountdown(){const{width:e,height:t}=this.cameras.main,i=this.add.text(e/2,t/2-50,"3",{fontSize:"72px",fontFamily:"Arial",color:"#FFD700",stroke:"#003566",strokeThickness:6}).setOrigin(.5).setScrollFactor(0).setDepth(1e3);let s=3;this.time.addEvent({delay:1e3,repeat:3,callback:()=>{s--,s>0?(i.setText(s.toString()),this.tweens.add({targets:i,scaleX:1.5,scaleY:1.5,duration:200,yoyo:!0})):s===0&&(i.setText("GO!"),i.setColor("#76FF03"),this.tweens.add({targets:i,scaleX:2,scaleY:2,alpha:0,duration:500,onComplete:()=>{i.destroy(),this.isCountingDown=!1,this.audioManager.playMusic()}}))}});const n=this.players.find(a=>!a.isBot);this.render3D(n)}async endGame(){if(this.gameOver=!0,this.audioManager.stopMusic(),this.audioManager.playSfx("win"),!this.isReplay){const t={version:1,seed:this.seed,mode:this.mode,settings:this.settings,frames:this.replayFrames,startTime:Date.now(),playerName:"You"},i=this.players.find(a=>!a.isBot),s=`replay_${Date.now()}`;await x.saveReplay(s,t);const n=await x.loadStats();n.totalRuns++,i.finishPosition===1&&n.totalWins++,i.finishTime<n.bestTime&&(n.bestTime=i.finishTime),n.totalScore+=i.score,await x.saveStats(n)}const e=[...this.players].sort((t,i)=>t.finishPosition-i.finishPosition);this.time.delayedCall(1e3,()=>{this.scene.start("ResultsScene",{players:e,mode:this.mode,elapsedTime:this.elapsedTime})})}shutdown(){this.controls&&this.controls.destroy(),this.audioManager.stopMusic()}}function se(l){const e={v:l.version,s:l.seed,m:l.mode,f:l.frames.map(i=>({t:i.tick,i:(i.inputs.left?1:0)|(i.inputs.right?2:0)|(i.inputs.jump?4:0)}))},t=JSON.stringify(e);return btoa(t)}function ne(l){try{const e=atob(l),t=JSON.parse(e);return{version:t.v,seed:t.s,mode:t.m,settings:{},frames:t.f.map(i=>({tick:i.t,inputs:{left:!!(i.i&1),right:!!(i.i&2),jump:!!(i.i&4)}})),startTime:0,playerName:"Replay"}}catch{return null}}class ae extends y.Scene{constructor(){super({key:"ReplayScene"}),this.action="list"}init(e){this.action=e.action||"list",this.replayId=e.replayId}async create(){if(this.action==="play"&&this.replayId){await this.playReplay(this.replayId);return}await this.showReplayList()}async showReplayList(){const{width:e,height:t}=this.cameras.main,i=this.add.graphics();i.fillGradientStyle(13670,13670,30646,46296,1),i.fillRect(0,0,e,t),this.add.text(e/2,40,"REPLAYS",{fontSize:"32px",fontFamily:"Arial",color:"#FFFFFF",stroke:"#003566",strokeThickness:4}).setOrigin(.5);const s=await x.listReplays();if(s.length===0)this.add.text(e/2,t/2,`No replays saved yet.
Play some races first!`,{fontSize:"18px",fontFamily:"Arial",color:"#CAF0F8",align:"center"}).setOrigin(.5);else{let n=100;s.slice(0,10).forEach(a=>{this.createReplayRow(30,n,a,e),n+=60})}this.checkUrlReplay(),this.add.text(e/2,t-60,"Back to Menu",{fontSize:"18px",fontFamily:"Arial",color:"#CAF0F8"}).setOrigin(.5),this.add.zone(e/2,t-60,200,40).setInteractive().on("pointerdown",()=>{this.scene.start("MenuScene")})}createReplayRow(e,t,i,s){const n=this.add.graphics();n.fillStyle(13670,.6),n.fillRoundedRect(e,t,s-60,50,8);const a=new Date(i.date),r=`${a.getMonth()+1}/${a.getDate()} ${a.getHours()}:${a.getMinutes().toString().padStart(2,"0")}`;this.add.text(e+10,t+8,r,{fontSize:"12px",fontFamily:"Arial",color:"#90E0EF"}),this.add.text(e+10,t+28,`${i.mode} - #${i.position}`,{fontSize:"14px",fontFamily:"Arial",color:"#FFFFFF"}),this.add.text(e+180,t+18,`Score: ${i.score}`,{fontSize:"14px",fontFamily:"Arial",color:"#FFD700"});const o=this.add.graphics();o.fillStyle(46296,.9),o.fillRoundedRect(s-110,t+8,60,34,8),this.add.text(s-80,t+25,"Play",{fontSize:"14px",fontFamily:"Arial",color:"#FFFFFF"}).setOrigin(.5),this.add.zone(s-80,t+25,60,34).setInteractive().on("pointerdown",()=>{this.playReplay(i.id)});const c=this.add.graphics();c.fillStyle(13670,.9),c.fillRoundedRect(s-170,t+8,52,34,8),this.add.text(s-144,t+25,"Share",{fontSize:"12px",fontFamily:"Arial",color:"#CAF0F8"}).setOrigin(.5),this.add.zone(s-144,t+25,52,34).setInteractive().on("pointerdown",async()=>{await this.shareReplay(i.id)})}async playReplay(e){const t=await x.loadReplay(e);t&&this.scene.start("GameScene",{mode:t.mode,settings:t.settings,replay:t})}async shareReplay(e){const t=await x.loadReplay(e);if(!t)return;const i=se(t),s=`${window.location.origin}${window.location.pathname}#replay=${i}`;navigator.clipboard?(await navigator.clipboard.writeText(s),this.showToast("Replay link copied!")):this.showToast("Share not available")}checkUrlReplay(){const e=window.location.hash;if(e.startsWith("#replay=")){const t=e.substring(8);try{const i=ne(t);i&&this.scene.start("GameScene",{mode:i.mode,settings:i.settings,replay:i})}catch{}}}showToast(e){const{width:t,height:i}=this.cameras.main,s=this.add.text(t/2,i-120,e,{fontSize:"16px",fontFamily:"Arial",color:"#FFFFFF",backgroundColor:"#003566",padding:{x:12,y:6}}).setOrigin(.5);this.tweens.add({targets:s,alpha:0,y:i-140,duration:2e3,delay:1e3,onComplete:()=>s.destroy()})}}class re extends y.Scene{constructor(){super({key:"SettingsScene"}),this.sliders=new Map}async create(){this.settings=await x.loadSettings();const{width:e,height:t}=this.cameras.main,i=this.add.graphics();i.fillGradientStyle(13670,13670,30646,46296,1),i.fillRect(0,0,e,t),this.add.text(e/2,40,"SETTINGS",{fontSize:"32px",fontFamily:"Arial",color:"#FFFFFF",stroke:"#003566",strokeThickness:4}).setOrigin(.5);let s=100;const n=30;this.addSectionTitle(e/2,s,"Audio"),s+=35,this.addSlider(40,s,"Master Volume",this.settings.masterVolume,a=>{this.settings.masterVolume=a}),s+=50,this.addSlider(40,s,"Music",this.settings.musicVolume,a=>{this.settings.musicVolume=a}),s+=50,this.addSlider(40,s,"SFX",this.settings.sfxVolume,a=>{this.settings.sfxVolume=a}),s+=40,this.addToggle(40,s,"Mute All",this.settings.muted,a=>{this.settings.muted=a}),s+=n+30,this.addSectionTitle(e/2,s,"Controls"),s+=35,this.addOptionSelector(40,s,"Scheme",["buttons","swipe","tilt"],this.settings.controlScheme,a=>{this.settings.controlScheme=a}),s+=40,this.addToggle(40,s,"Tilt Steering",this.settings.tiltEnabled,a=>{this.settings.tiltEnabled=a}),s+=n+30,this.addSectionTitle(e/2,s,"Graphics"),s+=35,this.addOptionSelector(40,s,"Quality",["low","medium","high"],this.settings.quality,a=>{this.settings.quality=a}),s+=n+30,this.addSectionTitle(e/2,s,"Gameplay"),s+=35,this.addSlider(40,s,`Bots: ${this.settings.botCount}`,this.settings.botCount/15,a=>{this.settings.botCount=Math.max(1,Math.round(a*15))}),s+=50,this.addSlider(40,s,`Time: ${this.settings.matchLength}s`,this.settings.matchLength/120,a=>{this.settings.matchLength=Math.max(15,Math.round(a*120))}),this.addButton(e/2-80,t-80,"Save & Back",async()=>{await x.saveSettings(this.settings),E.getInstance().applySettings(this.settings),this.scene.start("MenuScene")}),this.addButton(e/2+80,t-80,"Reset",async()=>{this.settings={...v},await x.saveSettings(this.settings),this.scene.restart()})}addSectionTitle(e,t,i){this.add.text(e,t,i,{fontSize:"18px",fontFamily:"Arial",color:"#FFD700",fontStyle:"bold"}).setOrigin(.5);const s=this.add.graphics();s.lineStyle(1,16766720,.5),s.lineBetween(40,t+12,this.cameras.main.width-40,t+12)}addSlider(e,t,i,s,n){const a=this.cameras.main.width-80;this.add.text(e,t-10,i,{fontSize:"14px",fontFamily:"Arial",color:"#CAF0F8"});const r=this.add.graphics();r.fillStyle(13670,1),r.fillRoundedRect(e,t+8,a,8,4),r.fillStyle(46296,1),r.fillRoundedRect(e,t+8,a*s,8,4);const o=e+a*s,c=this.add.graphics();c.fillStyle(16777215,1),c.fillCircle(0,0,10),c.setPosition(o,t+12);const u=this.add.zone(e+a/2,t+12,a+20,30).setInteractive();u.on("pointerdown",h=>{const d=y.Math.Clamp((h.x-e)/a,0,1);c.setPosition(e+a*d,t+12),r.clear(),r.fillStyle(13670,1),r.fillRoundedRect(e,t+8,a,8,4),r.fillStyle(46296,1),r.fillRoundedRect(e,t+8,a*d,8,4),n(d)}),u.on("pointermove",h=>{if(!h.isDown)return;const d=y.Math.Clamp((h.x-e)/a,0,1);c.setPosition(e+a*d,t+12),r.clear(),r.fillStyle(13670,1),r.fillRoundedRect(e,t+8,a,8,4),r.fillStyle(46296,1),r.fillRoundedRect(e,t+8,a*d,8,4),n(d)})}addToggle(e,t,i,s,n){this.add.text(e,t,i,{fontSize:"14px",fontFamily:"Arial",color:"#CAF0F8"});const a=this.add.graphics(),r=this.add.graphics(),o=u=>{a.clear(),a.fillStyle(u?46296:13670,1),a.fillRoundedRect(280,t-2,50,24,12),r.clear(),r.fillStyle(16777215,1),r.fillCircle(u?318:292,t+10,10)};o(s);let c=s;this.add.zone(305,t+10,50,24).setInteractive().on("pointerdown",()=>{c=!c,o(c),n(c)})}addOptionSelector(e,t,i,s,n,a){this.add.text(e,t,i,{fontSize:"14px",fontFamily:"Arial",color:"#CAF0F8"});let r=s.indexOf(n);const o=80,c=140,u=[];s.forEach((d,p)=>{const f=c+p*(o+10),S=this.add.graphics();this.add.text(f+o/2,t+2,d,{fontSize:"12px",fontFamily:"Arial",color:"#FFFFFF"}).setOrigin(.5),u.push(S),this.add.zone(f+o/2,t+2,o,24).setInteractive().on("pointerdown",()=>{r=p,a(s[p]),h()})});const h=()=>{u.forEach((d,p)=>{d.clear();const f=c+p*(o+10);d.fillStyle(p===r?46296:13670,1),d.fillRoundedRect(f,t-10,o,24,8)})};h()}addButton(e,t,i,s){const n=this.add.graphics();n.fillStyle(30646,.9),n.fillRoundedRect(e-65,t-18,130,36,10),this.add.text(e,t,i,{fontSize:"14px",fontFamily:"Arial",color:"#FFFFFF"}).setOrigin(.5),this.add.zone(e,t,130,36).setInteractive().on("pointerdown",s)}}class le extends y.Scene{constructor(){super({key:"ResultsScene"}),this.players=[],this.elapsedTime=0}init(e){this.players=e.players||[],this.mode=e.mode||"classic",this.elapsedTime=e.elapsedTime||0}create(){const{width:e,height:t}=this.cameras.main,i=this.add.graphics();i.fillGradientStyle(13670,13670,30646,46296,1),i.fillRect(0,0,e,t),this.createConfetti(e,t);const s=this.players.find(c=>!c.isBot),n=s?this.getPositionText(s.finishPosition):"";this.add.text(e/2,60,"RACE COMPLETE!",{fontSize:"32px",fontFamily:"Arial",color:"#FFD700",stroke:"#003566",strokeThickness:4}).setOrigin(.5),s&&this.add.text(e/2,110,`You finished ${n}!`,{fontSize:"24px",fontFamily:"Arial",color:s.finishPosition===1?"#FFD700":"#FFFFFF"}).setOrigin(.5);const a=170,r=50;this.players.slice(0,8).forEach((c,u)=>{const h=a+u*r,d=!c.isBot,p=this.add.graphics();p.fillStyle(d?16766720:13670,d?.3:.5),p.fillRoundedRect(30,h-15,e-60,40,8),this.add.text(50,h,`#${c.finishPosition}`,{fontSize:"18px",fontFamily:"Arial",color:u===0?"#FFD700":u===1?"#C0C0C0":u===2?"#CD7F32":"#FFFFFF",fontStyle:"bold"}).setOrigin(0,.5);const f=this.add.graphics();f.fillStyle(P[c.skinIndex]||16777215,1),f.fillCircle(95,h,8),this.add.text(115,h,c.name,{fontSize:"16px",fontFamily:"Arial",color:d?"#FFE66D":"#CAF0F8"}).setOrigin(0,.5),this.add.text(250,h,this.formatTime(c.finishTime),{fontSize:"14px",fontFamily:"Arial",color:"#90E0EF"}).setOrigin(0,.5),this.add.text(340,h,`${c.score}`,{fontSize:"14px",fontFamily:"Arial",color:"#FFD700",fontStyle:"bold"}).setOrigin(1,.5)});const o=a+Math.min(this.players.length,8)*r+20;this.add.text(e/2,o,`Mode: ${this.mode} | Time: ${this.formatTime(this.elapsedTime)}`,{fontSize:"14px",fontFamily:"Arial",color:"#90E0EF"}).setOrigin(.5),this.createButton(e/2,o+60,"Play Again",()=>{this.scene.start("GameScene",{mode:this.mode})}),this.createButton(e/2,o+120,"Main Menu",()=>{this.scene.start("MenuScene")}),E.getInstance().playSfx("win")}createButton(e,t,i,s){const n=this.add.graphics();n.fillStyle(30646,.9),n.fillRoundedRect(e-100,t-22,200,44,12),n.lineStyle(2,13299960,1),n.strokeRoundedRect(e-100,t-22,200,44,12),this.add.text(e,t,i,{fontSize:"18px",fontFamily:"Arial",color:"#FFFFFF"}).setOrigin(.5),this.add.zone(e,t,200,44).setInteractive().on("pointerdown",s)}createConfetti(e,t){const i=[16739179,5164484,16770669,9822675,15958401,11179738];for(let s=0;s<40;s++){const n=this.add.rectangle(y.Math.Between(0,e),y.Math.Between(-50,-10),y.Math.Between(4,8),y.Math.Between(4,8),y.Utils.Array.GetRandom(i));this.tweens.add({targets:n,y:t+20,x:n.x+y.Math.Between(-50,50),angle:y.Math.Between(0,360),duration:y.Math.Between(2e3,4e3),repeat:-1,delay:y.Math.Between(0,2e3)})}}getPositionText(e){return e===1?"1st":e===2?"2nd":e===3?"3rd":`${e}th`}formatTime(e){const t=Math.floor(e/60),i=Math.floor(e%60),s=Math.floor(e%1*100);return`${t}:${i.toString().padStart(2,"0")}.${s.toString().padStart(2,"0")}`}}const oe={type:y.AUTO,parent:"game-container",width:390,height:844,scale:{mode:y.Scale.FIT,autoCenter:y.Scale.CENTER_BOTH},backgroundColor:"#87CEEB",physics:{default:"arcade",arcade:{gravity:{x:0,y:0},debug:!1}},scene:[X,U,ie,le,ae,re],render:{pixelArt:!1,antialias:!0},input:{activePointers:3}};new y.Game(oe);"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("./service-worker.js").catch(()=>{})});
